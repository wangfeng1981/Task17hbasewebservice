<!DOCTYPE html>
<html class="ide mdl-js" lang="en">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
        <title>在线编辑</title>
        <link rel="stylesheet" href="./css/base.css" />
        <link rel="stylesheet" href="./css/ol.css" />
        <link rel="stylesheet" href="./css/editcodepanel.css" />
        <link rel="stylesheet" href="./js/bootstrap-3.3.7-dist/css/bootstrap.css" />
        <link rel="stylesheet" href="./iconfont/iconfont.css">
        <link rel="stylesheet" href="./css/dragula.min.css" />
        <link rel="stylesheet" href="./css/gutter.css" />
        <link rel="stylesheet" href="./css/jquery-ui.css" >

        <style type="text/css" media="screen">

        .editorContainer { 
                width:100%;
                height: calc(100% - 35px);
                margin-top: 5px;
            } 

/*            .editorContainer { 
                position: absolute;
                top: 45px;
                right: 1px;
                bottom: 32px;
                left: 1px;
            } 

            .editorFooter{
                position: absolute;
                bottom: 0px;
                left: 0px;
                right: 0px;
                height: 30px;
                margin: 0px;
                padding: 2px;
                background-color: #E9E9E9;
            }

            */
            .editorFooter{
                height: 34px;
                background-color: #E9E9E9;
            }
            .editorFooterButton{
                float: right;
                height:34px;
            }

        </style>
    </head>
    <body>
    <div id="head">
        <div id="logo">
            logo
        </div>

        <div id="search-container">
            <div class="row">

                <div class="col-lg-6">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search for...">
                        <span class="input-group-btn">
                        <button class="btn btn-default" type="button">search</button>
                        </span>
                    </div><!-- /input-group -->
                </div><!-- /.col-lg-6 -->
            </div><!-- /.row -->
        </div>

        <div class="user-box">

            <a href="javascript:;">登录</a>/<a href="javascript:;">注册</a>
        </div>
    </div>


    <div style="height:100%;" >
        <!--main-->
        <div  id="upperPanel"  style="width: 100%;">
            <div style="position: relative;height: 100%; ">
                <div id="upperPanel1" style="float:left;height: 100%; overflow: hidden; " >
                    <div id="upperPanel1tabs" style="height: 100%;">
                        <ul class="nav nav-tabs" id="panel1headers" role="tablist">
                          <li class="nav-item">
                            <a class="nav-link active" id="panel1-tab1" data-toggle="tab" href="#p1t1content" role="tab" aria-controls="p1t1content" aria-selected="true">脚本</a>
                          </li>
                          <li class="nav-item">
                            <a class="nav-link" id="panel1-tab2" data-toggle="tab" href="#p1t2content" role="tab" aria-controls="p1t2content" aria-selected="false">资源</a>
                          </li>
                          <li class="nav-item">
                            <a class="nav-link" id="panel1-tab3" data-toggle="tab" href="#p1t3content" role="tab" aria-controls="p1t3content" aria-selected="false">文档</a>
                          </li>
                        </ul>
                        <div class="tab-content" style="height: calc(100% - 42px);">
                          <div class="tab-pane fade active" id="p1t1content" role="tabpanel" aria-labelledby="panel1-tab1"
                            style="height:100%;">
                             
                            <button class="btn btn-primary btn-sm" style="margin-left: 10px; margin-top: 5px;margin-bottom: 5px;" onclick="updateScriptHandler()">刷新</button>
                            <ul id="scriptlist" style="width: 100%;height: calc(100% - 40px);overflow: auto;">
                            </ul>
                             
                            
                          </div>
                          <div class="tab-pane fade" id="p1t2content" role="tabpanel" aria-labelledby="panel1-tab2"
                            style="height: 100%;">
                              <button class="btn btn-primary btn-sm" style="margin-left: 10px; margin-top: 5px;margin-bottom: 5px;" onclick="updateProductListHandler()">刷新</button>
                                <ul id="productlist" style="width: 100%;height: calc(100% - 40px);overflow: auto;">
                                </ul>
                          </div>
                          <div class="tab-pane fade" id="p1t3content" role="tabpanel" aria-labelledby="panel1-tab3"></div>
                        </div>
                    </div>
                </div>
                 <!-- 请点击脚本中的条目加载保存的脚本，或者<button class="btn btn-success" onclick="onNewScriptClick()">新建</button>一个脚本项。 -->
                <div id="upperPanel2" style="float:left;height: 100%; overflow: hidden; " >
                    <div id="upperPanel2tabs" style="height: 100%;">
                        <div id="noscriptwarning">请点击脚本中的条目加载保存的脚本，或者<button class="btn btn-success" onclick="onNewScriptClick()">新建</button>一个脚本项。</div>
                        <ul class="nav nav-tabs" id="panel2headers" role="tablist">
                        </ul>
                        <div class="tab-content" id="panel2contents" style="height: calc(100% - 42px);">
                        </div>
                    </div>
                </div>
                 
                <div id="upperPanel3" style="float:left;height: 100%; overflow: hidden; " >
                    <div id="upperPanel3tabs" style="height: 100%;">
                        <ul class="nav nav-tabs" id="panel3headers" role="tablist">
                          <li class="nav-item">
                            <a class="nav-link active" id="panel3-tab1" data-toggle="tab" href="#p3t1content" role="tab" aria-controls="p3t1content" aria-selected="true">输出</a>
                          </li>
                          <li class="nav-item">
                            <a class="nav-link" id="panel3-tab2" data-toggle="tab" href="#p3t2content" role="tab" aria-controls="p3t2content" aria-selected="false">离线任务</a>
                          </li>
                        </ul>
                        <div class="tab-content" style="height: calc(100% - 42px);">
                          <div class="tab-pane fade active" id="p3t1content" role="tabpanel" aria-labelledby="panel3-tab1"
                            style="height:100%;">
                             
                            <button class="btn btn-primary btn-sm" style="margin-left: 10px; margin-top: 5px;margin-bottom: 5px;" onclick="">清空</button>                             
                            
                          </div>
                          <div class="tab-pane fade" id="p3t2content" role="tabpanel" aria-labelledby="panel3-tab2"
                            style="height: 100%;">
                            <button class="btn btn-primary btn-sm" style="margin-left: 10px; margin-top: 5px;margin-bottom: 5px;" onclick="updateOffTaskListHandler()">刷新</button>
                            <ul id="offtasklist" style="width: 100%;height: calc(100% - 40px);overflow: auto;">
                            </ul>
                          </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>

        <!--map-->
        <div class="mapcontainter" id="downPanel" style="z-index: 50;">

            <div id="map">
                <div class="tool_button">
                    <span><img style="width:23px;height:23px;margin:0px;" src="img/hand.png" onclick="onHandClick()" /></span>
                    <span><img style="width:23px;height:23px;margin:0px;" src="img/square.png" onclick="onRectClick()" /></span>
                    <span><img style="width:23px;height:23px;margin:0px;" src="img/polygon.png" onclick="onPolygonClick()"/></span>
                </div>
                <!--sortable-->
                <div class="dragPanel" >
                    <ul id="layersContainer"  class="list-group col">
                       <!-- <li class="list-group-item layerItem unselected"  id="layerId1">
                            <div class="openEye">
                                <i class=" iconfont icon-yanjing"></i>
                            </div>
                            <div class="layerInfo  ">
                                <div class="layer_name">
                                    Corrected Reflectance (True Color)<br>
                                    Suomi NPP / VIIRS
                                </div>
                                <div class="layer_control">
                                    <span class="control_btn" onclick="alert(1)"><i class=" iconfont icon-tishi"></i></span>
                                    <span class="control_btn"  onclick="alert(2)"><i class=" iconfont icon-liebiao"></i></span>
                                    <span class="control_btn"  onclick="alert(3)"><i class=" iconfont icon-guanbi"></i></span>

                                </div>

                            </div>
                        </li>  -->
                         
                    </ul>
                    <div>
                        <button onclick="buttonAddLayerClick()">添加图层</button>
                    </div>
                </div> <!-- sortable -->
            </div> <!-- map -->
        </div>
    </div>
   

    <!-- ui-dialog -->
    <div id="dialog" title="添加图层"  >
        <div id="radioset-layertype">
            <input type="radio" id="openlayer" name="radio"><label for="openlayer">OpenLayer图层</label>
            <input type="radio" id="scriptlayer" name="radio" checked="checked"><label for="scriptlayer">编程图层</label>
        </div>
    </div>

    <!-- 离线任务对话框 -->
    <div id="offTaskDialog" title="离线任务配置"  >
        <label for="offtaskdate">输入日期时间参数:</label><input type="text" id="offtaskdate" name="offtaskdate">
    </div>

    
    <script src="./ace/ace.js"></script>
    <script src="./ace/ext-language_tools.js"></script>
    <!--引入加载代码段-->
    <script src="./ace/snippets/javascript.js"></script>
    <script src="./js/ol.js"></script>

    <script src="./js/jquery-3.3.1.min.js"></script>
    <script src="./js/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
    <script src='./js/dragula.min.js'></script>
    <script src="./js/split.min.js"></script>
    <script src="./js/jquery-ui.js"></script>
    <script src="./js/main.js"></script>
 

    <script>
    //全局变量
    //地图图层列表
    var globalLayerManager = [] ;



    //绘制感兴趣区图层
    var drawVectorLayerSource = new ol.source.Vector({wrapX: false});
    var drawVectorLayer = new ol.layer.Vector({
      source: drawVectorLayerSource,
    });



    //地图初始化
    var map = new ol.Map(
    {
        target:'map' ,
        layers:[
            new ol.layer.Tile({source: new ol.source.OSM()}) //OSM background
            ,drawVectorLayer
        ],
        view: new ol.View({
            projection: 'EPSG:4326',
            center:[0,0],
            /*// ol.proj.fromLonLat([37.41,8.82]),*/
            zoom:2,
            maxZoom:14
        })
    }) ;



    



    //图层拖拽功能
    var dragLayerList = dragula([document.getElementById("layersContainer")])
        .on('drop', function (el) {
            var numlayers = globalLayerManager.length ;
            console.log("print layers ordered.") ;

            $('#layersContainer').children().each( (index, element) => {

                for(var il = 0 ; il < numlayers ; ++il )
                {//obj.lyrliid
                    if( globalLayerManager[il].lyrliid === $(element).attr("id") )
                    {
                        globalLayerManager[il].wmtslayer.setZIndex( numlayers - index ) ;
                        console.log("htmlid -> zindex : " + globalLayerManager[il].lyrliid+ "->" + (numlayers-index ) ) ;
                        break ;
                    }
                }
            } ) ;

        });  



    //面板分割
    var theSplitUpper = Split(['#upperPanel1', '#upperPanel2','#upperPanel3'],
        {
            direction:'horizontal',
            minSize: [200,600,200],
            gutter: function (index, direction) {
                var gutter = document.createElement('div')
                gutter.className = 'gutter gutter-horizontal';
                return gutter;
            },
            gutterSize:10
        }
    );

    //上下窗口分割
    var theSplite = Split(['#upperPanel', '#downPanel'],
        {
            direction:'vertical',
            minSize: [0, 300],
            onDrag: function(sizes) {
                console.log(sizes);
                map.updateSize();
            },
            gutter: function (index, direction) {
                var gutter = document.createElement('div')
                gutter.className = 'gutter gutter-vertical';
                return gutter;
            }
        }
    );
    theSplite.setSizes([25,75]);

    //添加图层按钮动作
    function buttonAddLayerClick() {
        //  弹出对话框选择已有产品图层还是可编程图层
        //$( "#dialog" ).dialog( "open" );
        //event.preventDefault();offTaskDialog
    }



    //脚本编辑器
    ace.require("ace/ext/language_tools");


    //新建脚本事件
    function onNewScriptClick() {
        $.get("http://192.168.10.178:15900/pe/scripts/user/new/1", function(result){
            console.log(result);
            var newscriptid = result.sid;
            $.get("http://192.168.10.178:15900/pe/scripts/"+newscriptid, function(result2){
                console.log(result2);

                $("#noscriptwarning").hide() ;
                //在图层管理器中增加新图层
                var layerElement = addProgramLayerElement(
                    result2.sid,    
                    result2.title,
                    result2.scriptContent,
                    "#panel2headers",
                    "#panel2contents",
                    "#layersContainer",
                    map,
                    globalLayerManager) ;
                
            });
        });

    }

    //老脚本加载
    function onScriptItemClick(sid) {
        $.get("http://192.168.10.178:15900/pe/scripts/"+sid, function(result2){
            console.log(result2);

            $("#noscriptwarning").hide() ;
            //在图层管理器中增加新图层
            var layerElement = addProgramLayerElement(
                result2.sid,    
                result2.title,
                result2.scriptContent,
                "#panel2headers",
                "#panel2contents",
                "#layersContainer",
                map,
                globalLayerManager) ;
            
        });
    }

    

    </script>

    </body>
</html>

